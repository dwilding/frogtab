<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Routine - Frogtab</title>
    <link rel="icon" href="/icon.svg" type="image/svg+xml" id="icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/style.css">
  </head>
  <body>
    <div class="container">
      <div class="interface">
        <div class="tabs">
          <div class="tab">
            <span id="tab-mon" class="tab-name selected">Mon</span>
            <span id="tab-tue" class="tab-name">Tue</span>
            <span id="tab-wed" class="tab-name">Wed</span>
            <span id="tab-thu" class="tab-name">Thu</span>
            <span id="tab-fri" class="tab-name">Fri</span>
            <span id="tab-sat" class="tab-name">Sat</span>
            <span id="tab-sun" class="tab-name">Sun</span>
          </div>
        </div>
        <div class="main">
          <textarea id="editor" class="restricted" placeholder="What do you usually do on Mondays?"></textarea>
        </div>
      </div>
    </div>
    <script>
      function switchToTab(tab) {
        if (tab != selectedTab) {
          dom[tab].classList.add("selected");
          dom[selectedTab].classList.remove("selected");
          selectedTab = tab;
        }
        refreshEditor();
      }
      function refreshView() {
        if (dom.editor.value != localStorage.getItem(`routine.${selectedTab}`)) {
          refreshEditor();
        }
      }
      function refreshEditor() {
        dom.editor.value = localStorage.getItem(`routine.${selectedTab}`);
        dom.editor.placeholder = `What do you usually do on ${plurals[selectedTab]}?`
        dom.editor.scrollTop = 0;
        dom.editor.setSelectionRange(0, 0);
      }
      async function startApp() {
        const weekdayToday = (new Date()).getDay();
        switchToTab(weekdayKeys[weekdayToday]);
        dom.mon.addEventListener("click", event => {
          switchToTab("mon");
        });
        dom.tue.addEventListener("click", event => {
          switchToTab("tue");
        });
        dom.wed.addEventListener("click", event => {
          switchToTab("wed");
        });
        dom.thu.addEventListener("click", event => {
          switchToTab("thu");
        });
        dom.fri.addEventListener("click", event => {
          switchToTab("fri");
        });
        dom.sat.addEventListener("click", event => {
          switchToTab("sat");
        });
        dom.sun.addEventListener("click", event => {
          switchToTab("sun");
        });
        dom.editor.addEventListener("input", event => {
          localStorage.setItem(`routine.${selectedTab}`, dom.editor.value);
        });
        window.addEventListener("storage", event => {
          refreshView();
        });
      }

      // ******** Initial setup ********
      const weekdayKeys = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
      for (const key of weekdayKeys) {
        if (localStorage.getItem(`routine.${key}`) === null) {
          localStorage.setItem(`routine.${key}`, "");
        }
      }
      const dom = {
        editor: document.getElementById("editor"),
        mon: document.getElementById("tab-mon"),
        tue: document.getElementById("tab-tue"),
        wed: document.getElementById("tab-wed"),
        thu: document.getElementById("tab-thu"),
        fri: document.getElementById("tab-fri"),
        sat: document.getElementById("tab-sat"),
        sun: document.getElementById("tab-sun")
      };
      let selectedTab = "mon";
      const plurals = {
        "mon": "Mondays",
        "tue": "Tuesdays",
        "wed": "Wednesdays",
        "thu": "Thursdays",
        "fri": "Fridays",
        "sat": "Saturdays",
        "sun": "Sundays"
      };
      startApp();
    </script>
  </body>
</html>