<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send to Frogtab</title>
    <link rel="icon" href="/icon.svg" type="image/svg+xml" id="icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/style.css">
    <script src="https://unpkg.com/openpgp@5.x/dist/openpgp.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="interface">
        <div class="popup">
          Connecting to Frogtab…
        </div>
        <div id="popup-default" class="popup display">
          <svg width="20px" height="20px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M20 17.607c1.494-.585 3-1.918 3-4.607 0-4-3.333-5-5-5 0-2 0-6-6-6S6 6 6 8c-1.667 0-5 1-5 5 0 2.689 1.506 4.022 3 4.607M7.58 19.487l1.768 1.768a4 4 0 005.657 0l.354-.353" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M7.934 21.962l-.353-2.475 2.474.354-2.12 2.121zM16.298 16.902l-1.768-1.768a4 4 0 00-5.657 0l-.353.353" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M15.944 14.427l.354 2.475-2.475-.354 2.121-2.121z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>Connecting to Frogtab…
        </div>
        <div id="popup-connected" class="popup">
          <svg width="20px" height="20px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M8 18l3 3 5-5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 17.607c1.494-.585 3-1.918 3-4.607 0-4-3.333-5-5-5 0-2 0-6-6-6S6 6 6 8c-1.667 0-5 1-5 5 0 2.689 1.506 4.022 3 4.607" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>Connection is end-to-end encrypted
        </div>
        <div id="popup-disconnected" class="popup">
          <svg width="20px" height="20px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M9 22l3-3m3-3l-3 3m0 0l-3-3m3 3l3 3M20 17.607c1.494-.585 3-1.918 3-4.607 0-4-3.333-5-5-5 0-2 0-6-6-6S6 6 6 8c-1.667 0-5 1-5 5 0 2.689 1.506 4.022 3 4.607" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>Not connected
        </div>
        <div class="main">
          <textarea id="editor" class="restricted" placeholder="Send to your inbox…"></textarea>
        </div>
        <div class="actions">
          <div class="action">
            <!-- Saved for later: <span class="action-instruction"><a href="#">Help</a><br><a href="#">Privacy</a></span> -->
          </div>
          <div class="action primary">
            <span id="send" class="circle-button"><svg width="24px" height="24px" viewBox="0 0 24 24" stroke-width="1.5" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M22 12L3 20l3.563-8L3 4l19 8zM6.5 12H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></span>
          </div>
        </div>
      </div>
    </div>
    <script>
      async function tryToGetUser(userID) {
        let response;
        try {
          response = await fetch(`https://api.frogtab.com/get-user?user_id=${encodeURIComponent(userID)}`);
        }
        catch (error) {
          return null;
        }
        if (!response.ok) {
          return null;
        }
        const result = await response.json();
        if (!result.success) {
          return null;
        }
        return {
          userID: result.user.user_id,
          pgpPublicKey: result.user.pgp_public_key
        };
      }
      async function tryToSend() {
        const valueToSend = dom.editor.value.trim();
        if (valueToSend == "") {
          return;
        }
        dom.editor.value = "";
        dom.editor.focus();
        dom.send.classList.add("fake-hover");
        setTimeout(() => {
          dom.send.classList.remove("enabled");
          dom.send.classList.remove("fake-hover");
        }, 300);
        const encryptedMessage = await openpgp.encrypt({
          message: await openpgp.createMessage({
            text: valueToSend
          }),
          encryptionKeys: user.pgpPublicKeyRead
        });
        let response;
        try {
          response = await fetch("https://api.frogtab.com/post-add-message", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              user_id: user.userID,
              message: encryptedMessage
            })
          });
        }
        catch (error) {
          return;
        }
        if (!response.ok) {
          return;
        }
        const result = await response.json();
        if (!result.success) {
          return;
        }
        console.log("Message sent!");
      }
      async function startApp() {
        user = await tryToGetUser(window.location.hash.substring(1));
        if (user === null) {
          dom.popups.default.classList.remove("display");
          dom.popups.disconnected.classList.add("display");
          dom.editor.placeholder = "";
          return;
        }
        console.log(`User ID: ${user.userID}`);
        user.pgpPublicKeyRead = await openpgp.readKey({
          armoredKey: user.pgpPublicKey
        });
        dom.popups.default.classList.remove("display");
        dom.popups.connected.classList.add("display");
        dom.editor.addEventListener("input", event => {
          const value = dom.editor.value.trim();
          if (value != "") {
            dom.send.classList.add("enabled");
          }
          else {
            dom.send.classList.remove("enabled");
          }
        });
        document.body.addEventListener("keydown", event => {
          if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() == 'enter') {
            event.preventDefault();
            tryToSend();
          }
        });
        send.addEventListener("click", event => {
          tryToSend();
        });
      }

      // ******** Initial setup ********
      const dom = {
        popups: {
          default: document.getElementById("popup-default"),
          connected: document.getElementById("popup-connected"),
          disconnected: document.getElementById("popup-disconnected")
        },
        editor: document.getElementById("editor"),
        send: document.getElementById("send")
      };
      let user;
      startApp();
    </script>
  </body>
</html>