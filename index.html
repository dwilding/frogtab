<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frogtab</title>
    <link rel="icon" href="/icon.svg" type="image/svg+xml" id="icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/style.css">
  </head>
  <body>
    <div class="container">
      <div class="interface">
        <div class="tabs">
          <div class="tab">
            <span id="tab-today" class="tab-name selected">Today</span><span id="tab-inbox" class="tab-name">Inbox</span><span class="tab-icon">â¬¤</span>
          </div>
          <div class="tab info">
            <span id="tab-info" class="info-message">Inbox sorted! Focus on today</span><span id="routine-enabled" class="info-message" title="Including actions from your weekly routine"><svg width="20px" height="20px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M18 8.4c0-1.697-.632-3.325-1.757-4.525C15.117 2.675 13.59 2 12 2c-1.591 0-3.117.674-4.243 1.875C6.632 5.075 6 6.703 6 8.4 6 15.867 3 18 3 18h18s-3-2.133-3-9.6zM13.73 21a1.999 1.999 0 01-3.46 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></span><span id="fetch-connected" class="info-message" title="Ready to receive messages from any device"><svg width="20px" height="20px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M12 4c-6 0-6 4-6 6-1.667 0-5 1-5 5s3.333 5 5 5h12c1.667 0 5-1 5-5s-3.333-5-5-5c0-2 0-6-6-6z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"></path></svg></span>
          </div>
        </div>
        <div class="main expand">
          <textarea id="editor"></textarea>
        </div>
      </div>
    </div>
    <script>
      async function storeIcons() {
        const icons = await fetchIcons();
        const blobIconNormal = await icons[0].blob();
        const blobIconNotify = await icons[1].blob();
        storedIcons.normal = URL.createObjectURL(blobIconNormal);
        storedIcons.notify = URL.createObjectURL(blobIconNotify);
      }
      async function fetchIcons() {
        return Promise.all([
          fetch("/icon.svg"),
          fetch("/icon-notify.svg")
        ]);
      }
      function switchToTabToday() {
        dom.today.classList.add("selected");
        dom.inbox.classList.remove("selected");
        selectedTab = "today";
        refreshEditor();
      }
      function switchToTabInbox() {
        dom.today.classList.remove("selected");
        dom.inbox.classList.add("selected");
        selectedTab = "inbox";
        refreshEditor();
      }
      function checkValue(value) {
        return value.match(/^\s*[^\s#]/m) !== null;
      }
      function setNotifyStatus() {
        const value = localStorage.getItem("value.inbox");
        if (checkValue(value) && !notifyInbox) {
          dom.inbox.classList.add("notify");
          dom.icon.setAttribute("href", storedIcons.notify);
          notifyInbox = true;
        }
        else if (!checkValue(value) && notifyInbox) {
          dom.inbox.classList.remove("notify");
          dom.icon.setAttribute("href", storedIcons.normal);
          notifyInbox = false;
        }
      }
      function setTab() {
        if (notifyInbox) {
          switchToTabInbox();
        }
        else {
          switchToTabToday();
        }
      }
      function refreshView() {
        setNotifyStatus();
        if (dom.editor.value != localStorage.getItem(`value.${selectedTab}`)) {
          refreshEditor();
          refreshInfo();
        }
      }
      function refreshEditor() {
        dom.editor.value = localStorage.getItem(`value.${selectedTab}`);
        dom.editor.scrollTop = 0;
        dom.editor.setSelectionRange(0, 0);
      }
      function refreshInfo() {
        dom.info.classList.remove("display");
        window.clearTimeout(timeoutShowInfo);
        if (selectedTab == "inbox" && !notifyInbox) {
          timeoutShowInfo = window.setTimeout(() => {
            dom.info.classList.add("display");
          }, 30 * 1000);
        }
      }
      function appendToInbox(value) {
        const valueToAppend = value.trim();
        if (valueToAppend == "") {
          return false;
        }
        let valueInbox = localStorage.getItem("value.inbox").trimStart();
        if (valueInbox != "") {
          valueInbox = `\n\n${valueInbox}`;
        }
        valueInbox = `${valueToAppend}${valueInbox}`;
        localStorage.setItem("value.inbox", valueInbox);
        return true;
      }
      function updateValues() {
        if (hasRoutine) {
          const routine = JSON.parse(localStorage.getItem("routine"));
          const weekdayToday = (new Date()).getDay();
          appendToInbox(routine[weekdayToday]);
        }
        appendToInbox(localStorage.getItem("value.today"));
        localStorage.setItem("value.today", "");
        const valueInbox = localStorage.getItem("value.inbox").replaceAll(/^( *#)+ */gm, "");
        localStorage.setItem("value.inbox", valueInbox);
      }
      function isNewDay() {
        const dateToday = (new Date()).toDateString();
        if (localStorage.getItem("date") == dateToday) {
          return false;
        }
        localStorage.setItem("date", dateToday);
        return true;
      }
      function displayUser() {
        console.log(`User ID: ${localStorage.getItem("user.userID")}`);
        console.log(`API key: ${localStorage.getItem("user.apiKey")}`);
        console.log(`PGP public key: ${localStorage.getItem("user.pgpPublicKey")}`);
      }
      async function appendMessages() {
        const messages = await sdk.fetchMessages();
        if (messages === null) {
          return;
        }
        for (const message of messages) {
          appendToInbox(message);
        }
        lastSuccessfulAppend = Date.now();
        dom.fetchConnected.classList.add("display");
      }
      function setRoutineStatus() {
        hasRoutine = false;
        if (localStorage.getItem("routine") !== null) {
          const routine = JSON.parse(localStorage.getItem("routine"));
          for (const entry of routine) {
            if (entry.trim() != "") {
              hasRoutine = true;
            }
          }
        }
        if (hasRoutine) {
          dom.routineEnabled.classList.add("display");
        }
        else {
          dom.routineEnabled.classList.remove("display");
        }
      }
      function defineRoutine(key, entry) {
        let routine = ["", "", "", "", "", "", ""];
        if (hasRoutine) {
          routine = JSON.parse(localStorage.getItem("routine"));
        }
        const keys = {
          mon: 1,
          tue: 2,
          wed: 3,
          thu: 4,
          fri: 5,
          sat: 6,
          sun: 0
        };
        if (key in keys) {
          routine[keys[key]] = entry.trim();
          localStorage.setItem("routine", JSON.stringify(routine));
          setRoutineStatus();
        }
      }
      function displayRoutine() {
        let routine = ["", "", "", "", "", "", ""];
        if (hasRoutine) {
          routine = JSON.parse(localStorage.getItem("routine"));
        }
        console.table({
          mon: routine[1],
          tue: routine[2],
          wed: routine[3],
          thu: routine[4],
          fri: routine[5],
          sat: routine[6],
          sun: routine[0],
        });
      }
      async function newLocalCredentials() {
        sdk = await import("/sdk.js");
        const localCredentials = await sdk.generateLocalCredentials();
        localStorage.setItem("user.userID", localCredentials.userID);
        localStorage.setItem("user.apiKey", localCredentials.apiKey);
        localStorage.setItem("user.pgpPublicKey", localCredentials.pgpPublicKey);
        localStorage.setItem("user.pgpPrivateKey", localCredentials.pgpPrivateKey);
        displayUser();
        hasPublicInbox = false;
      }
      async function startApp() {
        setRoutineStatus();
        if (isNewDay()) {
          updateValues();
        }
        switchToTabToday();
        await storeIcons();
        setNotifyStatus();
        setTab();
        dom.today.addEventListener("click", event => {
          switchToTabToday();
          refreshInfo();
        });
        dom.inbox.addEventListener("click", event => {
          switchToTabInbox();
          refreshInfo();
        });
        dom.editor.addEventListener("input", event => {
          localStorage.setItem(`value.${selectedTab}`, dom.editor.value);
          setNotifyStatus();
          refreshInfo();
        });
        document.body.addEventListener("keydown", event => {
          if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() == 'enter') {
            event.preventDefault();
            let value = dom.editor.value.trimStart();
            if (value != "") {
              value = `\n\n${value}`;
            }
            dom.editor.value = value;
            localStorage.setItem(`value.${selectedTab}`, dom.editor.value);
            refreshEditor();
            dom.editor.focus();
            refreshInfo();
          }
          else if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() == 'u') {
            event.preventDefault();
            switchToTabToday();
            dom.editor.focus();
            refreshInfo();
          }
          else if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() == 'i') {
            event.preventDefault();
            switchToTabInbox();
            dom.editor.focus();
            refreshInfo();
          }
        });
        if (localStorage.getItem("user.userID") !== null) {
          displayUser();
          sdk = await import("/sdk.js");
          hasPublicInbox = await sdk.setPublicInbox(localStorage.getItem("user.userID"));
          if (hasPublicInbox) {
            await sdk.setInboxOwner(
              localStorage.getItem("user.apiKey"),
              localStorage.getItem("user.pgpPrivateKey")
            );
            await appendMessages();
            setNotifyStatus();
            setTab();
          }
        }
        window.setInterval(async () => {
          if (isNewDay()) {
            updateValues();
            if (hasPublicInbox) {
              await appendMessages();
            }
            setNotifyStatus();
            setTab();
            refreshInfo();
          }
          else if (hasPublicInbox && Date.now() >= lastSuccessfulAppend + 600000) { // 600000 = 10 minutes
            await appendMessages();
            refreshView();
          }
        }, 15000); // 15000 = 15 seconds
        window.addEventListener("storage", event => {
          refreshView();
        });
        window.addEventListener("hashchange", () => {
          if (window.location.hash == "#advance") {
            window.location.hash = "";
            localStorage.setItem("date", "");
            isNewDay();
            updateValues();
            refreshView();
          }
        });
      }

      // ******** Initial setup ********
      if (localStorage.length == 0) {
        localStorage.setItem("value.today", "");
        localStorage.setItem("value.inbox", "");
        localStorage.setItem("date", (new Date()).toDateString());
      }
      const dom = {
        icon: document.getElementById("icon"),
        editor: document.getElementById("editor"),
        today: document.getElementById("tab-today"),
        inbox: document.getElementById("tab-inbox"),
        info: document.getElementById("tab-info"),
        routineEnabled: document.getElementById("routine-enabled"),
        fetchConnected: document.getElementById("fetch-connected")
      };
      const storedIcons = {};
      let notifyInbox = false;
      let selectedTab;
      let timeoutShowInfo;
      let sdk;
      let hasPublicInbox;
      let lastSuccessfulAppend = 0;
      let hasRoutine;
      startApp();
    </script>
  </body>
</html>