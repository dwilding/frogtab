<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Frogtab is a lightweight task manager that helps you stay focused on today's priorities">
    <title>Frogtab</title>
    <link rel="icon" href="/icon.svg" type="image/svg+xml" id="icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/style.css">
  </head>
  <body>
    <div class="container">
      <div class="interface">
        <div class="tabs">
          <div class="tab">
            <span id="tab-today" class="tab-name selected">Today</span>
            <span id="tab-inbox" class="tab-name">Inbox</span>
            <span class="tab-icon">â¬¤</span>
          </div>
          <div class="tab info">
            <span id="tab-info" class="info-message">Inbox is all set!</span>
            <span id="routine-enabled" class="info-message" title="Including actions from your weekly routine"><svg width="20px" height="20px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M12 18v-6m0 0V3.41a.6.6 0 01.836-.552l8.444 3.62a.6.6 0 01.022 1.093L12 12zM12 22c3.866 0 7-1.567 7-3.5S15.866 15 12 15s-7 1.567-7 3.5S8.134 22 12 22z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></span>
            <span id="fetch-connected" class="info-message" title="Ready to receive tasks from any device"><svg width="20px" height="20px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M12 4c-6 0-6 4-6 6-1.667 0-5 1-5 5s3.333 5 5 5h12c1.667 0 5-1 5-5s-3.333-5-5-5c0-2 0-6-6-6z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"></path></svg></span>
          </div>
        </div>
        <div class="main expand">
          <textarea id="editor"></textarea>
        </div>
        <div class="actions">
          <div class="action">
            <span class="action-instruction"><svg width="20px" height="20px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M3 5h18M3 12h18M3 19h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></span>
            <span id="enable-save" class="action-instruction">Enable auto-backup</span>
            <a id="export-data" class="action-instruction" href="#" download="Frogtab_backup.json">Export data</a>
          </div>
          <div class="action-menu">
            <a href="/week" target="_blank">Weekly Routine</span>
            <a href="/send" target="_blank">Send to Frogtab</span>
            <a href="#" target="_blank">Help &amp; Privacy</span>
          </div>
        </div>
      </div>
    </div>
    <script>
      async function storeIcons() {
        const icons = await fetchIcons();
        const iconBlobNormal = await icons[0].blob();
        const iconBlobNotify = await icons[1].blob();
        storedIcons.normal = URL.createObjectURL(iconBlobNormal);
        storedIcons.notify = URL.createObjectURL(iconBlobNotify);
      }
      async function fetchIcons() {
        return Promise.all([
          fetch("/icon.svg"),
          fetch("/icon-notify.svg")
        ]);
      }
      function switchToTabToday() {
        dom.today.classList.add("selected");
        dom.inbox.classList.remove("selected");
        selectedTab = "today";
        refreshEditor();
      }
      function switchToTabInbox() {
        dom.today.classList.remove("selected");
        dom.inbox.classList.add("selected");
        selectedTab = "inbox";
        refreshEditor();
      }
      function checkValue(value) {
        return value.match(/^\s*[^\s#]/m) !== null;
      }
      function setNotifyStatus() {
        const value = localStorage.getItem("value.inbox");
        if (checkValue(value) && !notifyInbox) {
          dom.inbox.classList.add("notify");
          dom.icon.setAttribute("href", storedIcons.notify);
          notifyInbox = true;
        }
        else if (!checkValue(value) && notifyInbox) {
          dom.inbox.classList.remove("notify");
          dom.icon.setAttribute("href", storedIcons.normal);
          notifyInbox = false;
        }
      }
      function setTab() {
        if (notifyInbox) {
          switchToTabInbox();
        }
        else {
          switchToTabToday();
        }
      }
      function refreshView() {
        setNotifyStatus();
        if (dom.editor.value != localStorage.getItem(`value.${selectedTab}`)) {
          refreshEditor();
          refreshInfo();
        }
      }
      function refreshEditor() {
        dom.editor.value = localStorage.getItem(`value.${selectedTab}`);
        dom.editor.scrollTop = 0;
        dom.editor.setSelectionRange(0, 0);
      }
      function refreshInfo() {
        dom.info.classList.remove("display");
        window.clearTimeout(timeoutShowInfo);
        if (selectedTab == "inbox" && !notifyInbox) {
          timeoutShowInfo = window.setTimeout(() => {
            dom.info.classList.add("display");
          }, 30000);
        }
      }
      function appendToInbox(value) {
        const valueToAppend = value.trim();
        if (valueToAppend == "") {
          return false;
        }
        let valueInbox = localStorage.getItem("value.inbox").trimStart();
        if (valueInbox != "") {
          valueInbox = `\n\n${valueInbox}`;
        }
        valueInbox = `${valueToAppend}${valueInbox}`;
        storeThenSave("value.inbox", valueInbox);
        return true;
      }
      function updateValues() {
        if (hasRoutine) {
          const weekdayToday = (new Date()).getDay();
          const key = weekdayKeys[weekdayToday];
          const routine = localStorage.getItem(`routine.${key}`);
          appendToInbox(routine);
        }
        appendToInbox(localStorage.getItem("value.today"));
        storeThenSave("value.today", "");
        const valueInbox = localStorage.getItem("value.inbox").replaceAll(/^( *#)+ */gm, "");
        storeThenSave("value.inbox", valueInbox);
      }
      function isNewDay() {
        const dateToday = (new Date()).toDateString();
        if (localStorage.getItem("date") == dateToday) {
          return false;
        }
        storeThenSave("date", dateToday);
        return true;
      }
      async function appendMessages() {
        const messages = await sdk.fetchMessages();
        if (messages === null) {
          return;
        }
        for (const message of messages) {
          appendToInbox(message);
        }
        lastSuccessfulAppend = Date.now();
        dom.fetchConnected.classList.add("display");
      }
      function setRoutineStatus() {
        hasRoutine = false;
        for (const key of weekdayKeys) {
          const routine = localStorage.getItem(`routine.${key}`);
          if (routine.trim() != "") {
            hasRoutine = true;
          }
        }
        if (hasRoutine) {
          dom.routineEnabled.classList.add("display");
        }
        else {
          dom.routineEnabled.classList.remove("display");
        }
      }
      function setExportAction() {
        if ("showSaveFilePicker" in window) {
          dom.enableSave.addEventListener("click", async event => {
            try {
              fileHandle = await window.showSaveFilePicker({
                suggestedName: `Frogtab_backup.json`,
                types: [{
                  description: "JSON files",
                  accept: {
                    "application/json": [
                      ".json"
                    ]
                  }
                }]
              });
            }
            catch (err) {
              return;
            }
            dom.enableSave.classList.remove("display");
            requestSave();
          });
          dom.enableSave.classList.add("display");
        }
        else {
          dom.exportData.addEventListener("click", event => {
            const dataJSON = createDataJSON();
            const dataBlob = new Blob([dataJSON], {
              type: "application/json; charset=utf-8"
            });
            dom.exportData.href = URL.createObjectURL(dataBlob);
          });
          dom.exportData.classList.add("display");
        }
      }
      function createDataJSON() {
        const data = {
          date: localStorage.getItem("date"),
          today: localStorage.getItem("value.today").trim(),
          inbox: localStorage.getItem("value.inbox").trim(),
          routine: {}
        };
        for (const key of weekdayKeys) {
          data["routine"][key] = localStorage.getItem(`routine.${key}`).trim();
        }
        if (localStorage.getItem("user.userID") !== null) {
          data["device"] = {
            userID: localStorage.getItem("user.userID"),
            apiKey: localStorage.getItem("user.apiKey"),
            pgpPublicKey: localStorage.getItem("user.pgpPublicKey"),
            pgpPrivateKey: localStorage.getItem("user.pgpPrivateKey")
          };
        }
        const dataJSON = JSON.stringify(data, null, 2);
        return (new TextEncoder()).encode(dataJSON);
      }
      function storeThenSave(key, value) {
        localStorage.setItem(key, value);
        requestSave();
      }
      function requestSave() {
        if (fileHandle !== null) {
          window.clearTimeout(timeoutSave);
          timeoutSave = window.setTimeout(saveToFile, 3000);
        }
      }
      async function saveToFile() {
        const dataJSON = createDataJSON();
        try {
          const stream = await fileHandle.createWritable();
          await stream.write(dataJSON);
          await stream.close();
        }
        catch (err) {
          fileHandle = null;
          dom.enableSave.classList.add("display");
        }
      }
      async function startApp() {
        setExportAction();
        setRoutineStatus();
        if (isNewDay()) {
          updateValues();
        }
        switchToTabToday();
        await storeIcons();
        setNotifyStatus();
        setTab();
        dom.today.addEventListener("click", event => {
          switchToTabToday();
          refreshInfo();
        });
        dom.inbox.addEventListener("click", event => {
          switchToTabInbox();
          refreshInfo();
        });
        dom.editor.addEventListener("input", async event => {
          storeThenSave(`value.${selectedTab}`, dom.editor.value);
          setNotifyStatus();
          refreshInfo();
        });
        document.body.addEventListener("keydown", event => {
          if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() == "enter") {
            event.preventDefault();
            let value = dom.editor.value.trimStart();
            if (value != "") {
              value = `\n\n${value}`;
            }
            dom.editor.value = value;
            storeThenSave(`value.${selectedTab}`, dom.editor.value);
            refreshEditor();
            dom.editor.focus();
            refreshInfo();
          }
          else if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() == "u") {
            event.preventDefault();
            switchToTabToday();
            dom.editor.focus();
            refreshInfo();
          }
          else if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() == "i") {
            event.preventDefault();
            switchToTabInbox();
            dom.editor.focus();
            refreshInfo();
          }
        });
        if (localStorage.getItem("user.userID") !== null) {
          sdk = await import("/sdk.js");
          hasPublicInbox = await sdk.setPublicInbox(localStorage.getItem("user.userID"));
          if (hasPublicInbox) {
            await sdk.setInboxOwner(
              localStorage.getItem("user.apiKey"),
              localStorage.getItem("user.pgpPrivateKey")
            );
            await appendMessages();
            setNotifyStatus();
            setTab();
          }
        }
        window.setInterval(async () => {
          if (isNewDay()) {
            updateValues();
            if (hasPublicInbox) {
              await appendMessages();
            }
            setNotifyStatus();
            setTab();
            refreshInfo();
          }
          else if (hasPublicInbox && Date.now() >= lastSuccessfulAppend + 600000) {
            await appendMessages();
            refreshView();
          }
        }, 15000);
        window.addEventListener("storage", event => {
          setRoutineStatus();
          refreshView();
          requestSave();
        });
      }

      // ******** Initial setup ********
      if (localStorage.getItem("date") === null) {
        localStorage.setItem("date", (new Date()).toDateString());
      }
      if (localStorage.getItem("value.today") === null) {
        localStorage.setItem("value.today", "Welcome to Frogtab! This box is your to-do list for today\n\nStart by writing down everything you'd like to accomplish today. As you complete your tasks, simply delete them\n\nUse your inbox to capture any thoughts or potential tasks that arise during the day. You can triage your inbox later");
      }
      if (localStorage.getItem("value.inbox") === null) {
        localStorage.setItem("value.inbox", "");
      }
      const weekdayKeys = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
      for (const key of weekdayKeys) {
        if (localStorage.getItem(`routine.${key}`) === null) {
          localStorage.setItem(`routine.${key}`, "");
        }
      }
      const dom = {
        icon: document.getElementById("icon"),
        editor: document.getElementById("editor"),
        today: document.getElementById("tab-today"),
        inbox: document.getElementById("tab-inbox"),
        info: document.getElementById("tab-info"),
        routineEnabled: document.getElementById("routine-enabled"),
        fetchConnected: document.getElementById("fetch-connected"),
        enableSave: document.getElementById("enable-save"),
        exportData: document.getElementById("export-data")
      };
      const storedIcons = {};
      let notifyInbox = false;
      let selectedTab;
      let fileHandle = null;
      let timeoutSave;
      let timeoutShowInfo;
      let hasRoutine;
      let sdk;
      let hasPublicInbox = false;
      let lastSuccessfulAppend = 0;
      startApp();
    </script>
  </body>
</html>
